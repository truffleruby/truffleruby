# NOTE: This is only a small subset of the CI which runs on GitHub Actions.
# Most of the CI is defined in ci.jsonnet.
name: CI
on:
  pull_request:
  push:
    branches: [master]
permissions:
  contents: read

jobs:
  lint:
    name: lint
    runs-on: ubuntu-22.04
    env:
      JT_JDK: '21'
    steps:
    - name: Clone TruffleRuby
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Necessary for jt check_abi
    - name: Setup system Ruby
      uses: ruby/setup-ruby@v1
    - name: Setup jt
      run: echo "$PWD/bin" >> $GITHUB_PATH

    - name: Restore ~/.mx/cache
      uses: actions/cache@v3
      with:
        path: ~/.mx/cache
        key: mx-cache-lint-${{ runner.os }}-${{ hashFiles('common.json') }}

    - uses: ./.github/actions/setup-jvmci-graal

    - run: jt install eclipse
    - name: Install RuboCop
      run: gem install --no-document rubocop:0.66.0
    - name: Build with --warning-as-error to ensure there are no non-deprecation warnings
      # See comment in ci.jsonnet about --jdt
      run: jt build -- --jdt builtin --warning-as-error --force-deprecation-as-warning
    - run: jt lint

  build:
    name: build jvm
    runs-on: ubuntu-22.04
    defaults:
      run:
        # Ensure all build files are in build/.
        # Test jobs don't have build/ to ensure nothing uses the build files.
        working-directory: build
    steps:
    - name: Clone TruffleRuby
      uses: actions/checkout@v4
      with:
        path: build
    - name: Setup system Ruby
      uses: ruby/setup-ruby@v1
      with:
        working-directory: build
    - name: Setup jt
      run: echo "$PWD/bin" >> $GITHUB_PATH

    - name: Restore ~/.mx/cache
      uses: actions/cache@v3
      with:
        path: ~/.mx/cache
        key: mx-cache-build-${{ runner.os }}-${{ hashFiles('build/common.json') }}

    - uses: ./build/.github/actions/setup-jvmci-graal

    - name: Build TruffleRuby
      run: jt build

    - name: Create archive
      run: |
        mv "$(jt -u jvm ruby-home)" "${{ github.workspace }}/truffleruby-jvm"
        cd ${{ github.workspace }}
        tar cf ${{ github.workspace }}/truffleruby-jvm.tar truffleruby-jvm
    - uses: actions/upload-artifact@v4
      with:
        name: truffleruby-jvm
        path: ${{ github.workspace }}/truffleruby-jvm.tar
        include-hidden-files: true

  build_native:
    name: build native
    runs-on: ubuntu-22.04
    defaults:
      run:
        # Ensure all build files are in build/.
        # Test jobs don't have build/ to ensure nothing uses the build files.
        working-directory: build
    steps:
      - name: Clone TruffleRuby
        uses: actions/checkout@v4
        with:
          path: build
      - name: Setup system Ruby
        uses: ruby/setup-ruby@v1
        with:
          working-directory: build
      - name: Setup jt
        run: echo "$PWD/bin" >> $GITHUB_PATH

      - name: Restore ~/.mx/cache
        uses: actions/cache@v3
        with:
          path: ~/.mx/cache
          key: mx-cache-build-native-${{ runner.os }}-${{ hashFiles('build/common.json') }}

      - uses: ./build/.github/actions/setup-jvmci-graal

      - run: free -m
      - name: Build TruffleRuby
        run: jt build --env native

      - name: Create archive
        run: |
          mv "$(jt -u native ruby-home)" "${{ github.workspace }}/truffleruby-native"
          cd ${{ github.workspace }}
          tar cf ${{ github.workspace }}/truffleruby-native.tar truffleruby-native
      - uses: actions/upload-artifact@v4
        with:
          name: truffleruby-native
          path: ${{ github.workspace }}/truffleruby-native.tar
          include-hidden-files: true

  test_unit_tck_polyglot:
    name: tests needing build files
    runs-on: ubuntu-22.04
    defaults:
      run:
        # Use build/ too for consistency in steps and cache reuse
        working-directory: build
    steps:
    - name: Clone TruffleRuby
      uses: actions/checkout@v4
      with:
        path: build
    - name: Setup system Ruby
      uses: ruby/setup-ruby@v1
      with:
        working-directory: build
    - name: Setup jt
      run: echo "$PWD/bin" >> $GITHUB_PATH

    - name: Restore ~/.mx/cache
      uses: actions/cache@v3
      with:
        path: ~/.mx/cache
        key: mx-cache-build-${{ runner.os }}-${{ hashFiles('build/common.json') }}

    - uses: ./build/.github/actions/setup-jvmci-graal

    - run: jt build
    - run: jt mx build
    - run: jt test unit --verbose
    - run: jt test tck
    - run: jt test polyglot
    # platform checks
    - run: ruby -e "pp RbConfig::MAKEFILE_CONFIG" # For convenience
    - run: ruby tool/generate-native-config.rb
    - run: cat src/main/java/org/truffleruby/platform/LinuxAMD64NativeConfiguration.java
    - run: tool/generate-config-header.sh
    - run: cat lib/cext/include/truffleruby/config_linux_amd64.h
    - run: jt check_native_configuration
    - run: jt check_config_header

  fast_specs:
    name: fast specs
    needs: [build]
    runs-on: ubuntu-22.04
    steps:
    - name: Clone TruffleRuby
      uses: actions/checkout@v4
    - name: Setup system Ruby
      uses: ruby/setup-ruby@v1
    - name: Setup jt
      run: echo "SYSTEM_RUBY=$(which ruby)" >> $GITHUB_ENV && echo "$PWD/bin" >> $GITHUB_PATH

    - uses: actions/download-artifact@v4
      with:
        name: truffleruby-jvm
    - uses: ./.github/actions/setup-truffleruby

    - run: jt test fast
    - run: jt test :next

  all_tests:
    name: specs ${{ matrix.test }}
    needs: [build]
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        test:
        - :truffle # ~15min
        - :language # ~3.5min
        - :core # ~9min
        - :library # ~2.5min
        - :cext # ~1.5min
        - :cxx
        - :security # ~0.75min
        - :command_line # ~5.5min
        - :tracepoint # ~0.5min
        - bundle # ~1.5min
        - cexts # ~12min
        - integration # ~10min
        - gems # ~3min
        - ecosystem # ~7min
        - basictest # ~0.5min
    steps:
      - name: Clone TruffleRuby
        uses: actions/checkout@v4
      - name: Setup system Ruby
        uses: ruby/setup-ruby@v1
      - name: Setup jt
        run: echo "SYSTEM_RUBY=$(which ruby)" >> $GITHUB_ENV && echo "$PWD/bin" >> $GITHUB_PATH

      - uses: actions/download-artifact@v4
        with:
          name: truffleruby-jvm
      - uses: ./.github/actions/setup-truffleruby

      - run: jt test ${{ matrix.test }}

  test_native:
    name: test native
    needs: [build_native]
    runs-on: ubuntu-22.04
    steps:
      - name: Clone TruffleRuby
        uses: actions/checkout@v4
      - name: Setup system Ruby
        uses: ruby/setup-ruby@v1
      - name: Setup jt
        run: echo "SYSTEM_RUBY=$(which ruby)" >> $GITHUB_ENV && echo "$PWD/bin" >> $GITHUB_PATH

      - uses: actions/download-artifact@v4
        with:
          name: truffleruby-native
      - uses: ./.github/actions/setup-truffleruby
        with:
          archive: truffleruby-native

      - run: jt test compiler
      # A subset of specs that are more likely to differ on native and run quickly
      - run: jt test :command_line
      - run: jt test :language
      # To catch slow :truffle specs which only apply to native
      - run: jt test fast :truffle

  test_mri:
    name: run MRI tests on native
    needs: [build_native]
    runs-on: ubuntu-22.04
    steps:
      - name: Clone TruffleRuby
        uses: actions/checkout@v4
      - name: Setup system Ruby
        uses: ruby/setup-ruby@v1
      - name: Setup jt
        run: echo "SYSTEM_RUBY=$(which ruby)" >> $GITHUB_ENV && echo "$PWD/bin" >> $GITHUB_PATH

      - uses: actions/download-artifact@v4
        with:
          name: truffleruby-native
      - uses: ./.github/actions/setup-truffleruby
        with:
          archive: truffleruby-native

      - run: jt test mri --fast --no-sulong

  ruby_spec_cruby:
    name: ruby/spec on CRuby ${{ matrix.ruby }}
    strategy:
      fail-fast: false
      matrix:
        ruby: ['3.2', '3.3', '3.4']
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby }}
          bundler: none
      - name: Setup jt
        run: echo "$PWD/bin" >> $GITHUB_PATH
      - run: CHECK_LEAKS=true jt -u ruby mspec -fdot --timeout 30 spec/ruby
